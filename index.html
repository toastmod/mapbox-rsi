<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time RSC Monitoring</title>
    <link href="./styles.css" rel="stylesheet">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    
</head>

<body>
    <div class ="ui-container">
        <div id="header">
            <div class="left-side">
                <a href = "./index.html" class="logo">
                    <img class="header-logo" src="./assets/lorwis.png" style = "height:100%; width: auto; align-items: center;">
                </a>
            </div>
            <div class="right-side">
                <a class="nav" href="#" onclick="panToIowa()">Home</a>
                <div class="dropdown nav">
                    <p>Tools</p>
                    <div class="dropdown-content">
                        <a href="#">Geostatistical Interpolation (RSI)</a>
                        <a href="#">Spatial Mapping (Demo)</a>
                    </div>
                </div>
                <a class="nav" href="https://sites.google.com/ualberta.ca/drtaejkwon/home?authuser=0" target="_blank" rel="noopener noreferrer">About</a>
                    <img class="header-logo uofa" src="./assets/uofa.png" style = "height:120%; width: auto">
                </a>
            </div>
        </div>
    
        
    
        <section id="console">
            <h1>Console</h1>
            <div><strong>ID:</strong>&nbsp;<span id="airid"></span></div>
        </section>
    </div> 
    <section class ="map-container">
        <div id="map"></div>
        <script> // Initialize map
            mapboxgl.accessToken = 'pk.eyJ1IjoidXJiaXp0b24iLCJhIjoiY2xsZTZvaXd0MGc4MjNzbmdseWNjM213eiJ9.z1YeFXYSbaMe93SMT6muVg';
            const map = new mapboxgl.Map({
                container: 'map', 
                style: 'mapbox://styles/urbizton/clve9aeu900c501rd7qcn14q6',
                center: [-93.53, 41.99],
                zoom: 6, 
                maxZoom: 14,
            });
            map.addControl(new mapboxgl.NavigationControl({visualizePitch: true}),'bottom-right');
            map.addControl(new mapboxgl.ScaleControl({maxWidth: 300, unit: 'imperial'})); // see if i can modify positioning later
            // const marker = new mapboxgl.Marker().setLngLat([30.5, 50.5]).addTo(map);
        </script>

        <script> // could probably make a new .js file holding all map related functions
            function panToIowa() {
                map.flyTo({
                    center: [-93.53, 41.99],
                    zoom: 6,
                    pitch: 0,
                    bearing: 0
                })
            }
            let pointID = null;

            map.on('load', () => {
                map.addSource('air-facilities', {
                    type: 'geojson',
                    // Use a URL for the value for the `data` property.
                    data: './assets/Air_Facilities.geojson'
                });

                map.addLayer({
                    'id': 'airfacilities-layer',
                    'type': 'circle',
                    'source': 'air-facilities',
                    'paint': {
                        'circle-color': [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            '#FF0000', // Red color when hover state is true
                            '#FFFFFF' // White color when hover state is false
                        ],
                        'circle-radius': [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            3,
                            3
                        ],
                        'circle-stroke-width': 1,
                        'circle-stroke-color': 'white'
                    }
                });
            });

            const idDisplay = document.getElementById('airid');

            map.on('mousemove', 'airfacilities-layer', (event) => {
                const features = map.queryRenderedFeatures(event.point, { layers: ['airfacilities-layer'] });

                // console.log('Features:', features); // Debug logging

                // Change cursor style
                map.getCanvas().style.cursor = features.length ? 'pointer' : '';

                if (!features.length) {
                    idDisplay.textContent = ''; // Clear the ID display if no feature is under the cursor
                    // Remove feature state if there's a previous feature
                    if (pointID) {
                        map.setFeatureState({
                            source: 'air-facilities',
                            id: pointID},
                            {hover: false
                            
                            });
                        pointID = null; // Reset pointID
                    }
                    return;
                }
                
                console.log(features)
                const objectId = features[0].properties.OBJECTID;
                idDisplay.textContent = objectId;

                // Check if features[0].id is valid
                // console.log('Feature ID:', objectId); // Debug logging

                // Remove previous feature state
                if (pointID) {
                    map.setFeatureState({
                        source: 'air-facilities',
                        id: pointID},
                        {hover: false

                    });
                }

                pointID = objectId;

                // Set feature state for the current feature
                map.setFeatureState(
                    { source: 'air-facilities', id: pointID },
                    { hover: true }
                );

            });
        </script>
    </section>

</body>
</html>